import { useState, useMemo, useEffect } from "react"
import OrdersTopbar from "../../components/orders/OrdersTopbar"
import DispatchOrdersTable from "../../components/orders/DispatchOrdersTable"
import DispatchFilterPanel from "../../components/orders/DispatchFilterPanel"
import ViewOrderDialog from "../../components/orders/ViewOrderDialog"
import SettingsDialog from "../../components/orders/SettingsDialog"
import { useGenericTableManagement } from "../../components/orders/useGenericTableManagement"
import { adminAPI } from "@/lib/api"
import { toast } from "sonner"
import { Loader2 } from "lucide-react"

export default function SearchingDeliveryMan() {
  const [orders, setOrders] = useState([])
  const [loading, setLoading] = useState(true)
  const [visibleColumns, setVisibleColumns] = useState({
    sl: true,
    order: true,
    date: true,
    customer: true,
    restaurant: true,
    total: true,
    status: true,
    actions: true,
  })
  const [searchQuery, setSearchQuery] = useState("")
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState("")

  // Debounce search query
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchQuery(searchQuery)
    }, 500) // 500ms delay

    return () => clearTimeout(timer)
  }, [searchQuery])

  // Fetch orders from API
  useEffect(() => {
    const fetchOrders = async () => {
      try {
        setLoading(true)
        const response = await adminAPI.getSearchingDeliverymanOrders({
          search: debouncedSearchQuery || undefined,
          limit: 1000 // Get all orders
        })

        if (response?.data?.success && response.data.data?.orders) {
          setOrders(response.data.data.orders)
        } else {
          setOrders([])
          if (response?.data?.message) {
            toast.error(response.data.message)
          }
        }
      } catch (error) {
        console.error("Error fetching searching deliveryman orders:", error)
        console.error("Error details:", {
          message: error.message,
          code: error.code,
          response: error.response ? {
            status: error.response.status,
            statusText: error.response.statusText,
            data: error.response.data
          } : null,
          request: error.request ? {
            url: error.config?.url,
            method: error.config?.method,
            baseURL: error.config?.baseURL
          } : null
        })
        
        if (error.response) {
          const status = error.response.status
          const errorData = error.response.data
          
          if (status === 401) {
            toast.error('Authentication required. Please login again.')
          } else if (status === 403) {
            toast.error('Access denied. You do not have permission.')
          } else if (status === 404) {
            toast.error('Endpoint not found. Please check backend server.')
          } else if (status >= 500) {
            toast.error('Server error. Please try again later.')
          } else {
            toast.error(errorData?.message || `Error ${status}: Failed to fetch orders`)
          }
        } else if (error.request) {
          toast.error('Cannot connect to server. Please check if backend is running.')
        } else {
          toast.error(error.message || 'Failed to fetch orders')
        }
        setOrders([])
      } finally {
        setLoading(false)
      }
    }

    fetchOrders()
  }, [debouncedSearchQuery])

  const {
    isFilterOpen,
    setIsFilterOpen,
    isSettingsOpen,
    setIsSettingsOpen,
    isViewOrderOpen,
    setIsViewOrderOpen,
    selectedOrder,
    filters,
    setFilters,
    filteredData,
    count,
    activeFiltersCount,
    handleApplyFilters,
    handleResetFilters,
    handleExport,
    handleViewOrder,
    handlePrintOrder,
    toggleColumn,
  } = useGenericTableManagement(
    orders,
    "Searching For Deliverymen Orders",
    ["id", "customerName", "restaurant", "customerPhone"]
  )

  const resetColumns = () => {
    setVisibleColumns({
      sl: true,
      order: true,
      date: true,
      customer: true,
      restaurant: true,
      total: true,
      status: true,
      actions: true,
    })
  }

  if (loading) {
    return (
      <div className="p-4 lg:p-6 bg-slate-50 min-h-screen flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
          <p className="text-gray-600">Loading orders...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="p-4 lg:p-6 bg-slate-50 min-h-screen">
      <div className="mb-4 flex items-center justify-between">
        <div>
          <h1 className="text-lg sm:text-xl font-semibold text-gray-900">
            Searching For Deliverymen Orders
          </h1>
          <p className="text-sm text-gray-500 mt-0.5">
            All orders that are currently searching for a deliveryman.
          </p>
        </div>
        <div className="flex items-center gap-2">
          <span className="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-xs font-medium text-blue-600 border border-blue-100">
            Unassigned Orders: {count}
          </span>
        </div>
      </div>
      <OrdersTopbar 
        title="Searching For Deliverymen Orders" 
        count={count} 
        searchQuery={searchQuery}
        setSearchQuery={setSearchQuery}
        onFilterClick={() => setIsFilterOpen(true)}
        activeFiltersCount={activeFiltersCount}
        onExport={handleExport}
        onSettingsClick={() => setIsSettingsOpen(true)}
      />
      <DispatchFilterPanel
        isOpen={isFilterOpen}
        onClose={() => setIsFilterOpen(false)}
        filters={filters}
        setFilters={setFilters}
        onApply={handleApplyFilters}
        onReset={handleResetFilters}
      />
      <SettingsDialog
        isOpen={isSettingsOpen}
        onOpenChange={setIsSettingsOpen}
        visibleColumns={visibleColumns}
        toggleColumn={toggleColumn}
        resetColumns={resetColumns}
        columnsConfig={{
          sl: "Serial Number",
          order: "Order",
          date: "Date",
          customer: "Customer",
          restaurant: "Restaurant",
          total: "Total Amount",
          status: "Order Status",
          actions: "Actions",
        }}
      />
      <ViewOrderDialog
        isOpen={isViewOrderOpen}
        onOpenChange={setIsViewOrderOpen}
        order={selectedOrder}
      />
      <DispatchOrdersTable 
        orders={filteredData} 
        visibleColumns={visibleColumns}
        onViewOrder={handleViewOrder}
        onPrintOrder={handlePrintOrder}
      />
    </div>
  )
}
